load_module modules/ngx_http_js_module.so;

http {
    include       mime.types;
    default_type  application/octet-stream;

    js_path "/etc/nginx/njs/";

    js_import status from status.js;

    upstream subgraph-svc {
        server indexer-service:7601;
    }

    upstream geo-svc {
        server geo-indexer-service:7602;
    }

    server {
        listen 7600;

        location = /geo-svc-status {
             internal;
             proxy_pass http://geo-svc/status;
         }

        location = /subgraph-svc-status {
            internal;
            proxy_pass http://subgraph-svc/status;
        }

        location = /subgraphs/id/${GEO_SUBGRAPH_DEPLOYMENT_ID} {
            proxy_pass http://geo-svc;
        }

        location ~ ^/subgraphs/ {
            proxy_pass http://subgraph-svc;
        }

        location /version {
            proxy_pass http://subgraph-svc;
        }

        location /cost {
            proxy_pass http://subgraph-svc;
        }

        location /status {
            js_content status.merge;
        }
    }
}

events {}
